{% extends "layouts/dashboard_base.html" %} 
{% load static %} 
{% load i18n %} 
{% load humanize %}
{% load math_filters %}

{% block title %} | {{ exchange_id|upper }}{% endblock title %} 


{% block dashboard_content %}
<div id="layout-content">
  <!--요약-->
  {% if error %}
    <div class="alert alert-warning">
      {{ error.message }}
      {% if error.action_url %}
        <a href="{{ error.action_url }}" class="btn btn-sm btn-primary">{{ error.action_label }}</a>
      {% endif %}
    </div>
  {% endif %}
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-medium">📊 포트폴리오</h3>
    <div class="flex items-center gap-2">
      <p id="last-updated-text" class="text-sm text-base-content/60">
        마지막 갱신: 불러오는 중...
      </p>
      <button
        hx-get="{% url 'dashboard:portfolio-summary-partial' exchange_id %}"
        hx-target="#portfolio-summary"
        hx-swap="innerHTML"
        class="btn btn-sm btn-accent gap-1 px-3"
      >
      <span class="iconify lucide--rotate-ccw size-4"></span>
        자산 갱신
      </button>
    </div>
  </div>
  
  <div id="summary-tab" class="mt-6">
    <div
      id="portfolio-summary"
      hx-get="{% url 'dashboard:portfolio-summary-partial' exchange_id %}"
      hx-trigger="load"
      hx-swap="innerHTML"
    >
        {% include "dashboard/partials/_portfolio_summary.html" %}
    </div>
  </div>
  <!--요약 끝-->
  <!-- 코인 목록-->
  <div class="mt-6">
    <div class="card bg-base-100 mt-5 shadow">
      <div class="card-body p-0">
        <div class="flex items-center justify-between px-5 pt-5">
          <div class="inline-flex items-center gap-3">
            <label class="input input-sm">
              <span
                class="iconify lucide--search text-base-content/80 size-3.5"
              ></span>
              <input
                class="w-24 sm:w-36"
                placeholder="Search along orders"
                aria-label="Search orders"
                type="search"
              />
            </label>
            <div class="hidden sm:block">
              <select class="select select-sm w-36" aria-label="Category">
                <option value="" disabled="" selected="">
                  Select Category
                </option>
                <option>Fashion</option>
                <option>Daily Need</option>
                <option>Cosmetic</option>
                <option>Electronics</option>
                <option>Food</option>
              </select>
            </div>
          </div>
          <a class="btn btn-sm btn-primary" href="./dashboards-ecommerce.html">
            <span class="iconify lucide--monitor-dot size-4"></span>
            <span class="hidden sm:inline">차트 보기</span>
          </a>
        </div>
        <div class="mt-4 overflow-auto">
          <table class="table">
            <thead>
              <tr>
                <th class="px-10">코인명</th>
                <th class="px-6">보유량</th>
                <th class="px-6">매수평균가</th>
                <th class="px-6">매수금액</th>
                <th class="px-6">평가금액</th>
                <th class="px-6">평가손익</th>
                <th class="px-6">수익률</th>
              </tr>
            </thead>
            <tbody
              id="portfolio-items"
              hx-get="{% url 'dashboard:portfolio-coins-partial' exchange_id %}"
              hx-trigger="load"
              hx-swap="innerHTML"
            >
              <!-- 보유한 코인들-->
              {% include "dashboard/partials/_portfolio_coins.html" %}
            </tbody>
          </table>
        </div>
        <div class="flex items-center justify-between p-6">
          <div class="text-base-content/80 hover:text-base-content flex items-center gap-2 text-sm">

            <span class="hidden sm:inline">페이지 당</span>
            <select class="select select-xs w-18"
                    aria-label="Per page"
                    onchange="location.href='?page=1&limit=' + this.value">
              <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
              <option value="20" {% if limit == 20 %}selected{% endif %}>20</option>
              <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
            </select>

          </div>
          
          <div class="inline-flex items-center gap-1">
            {% if page > 1 %}
              <a href="?page={{ page|add:"-1" }}&limit={{ limit }}"
                 class="btn btn-circle sm:btn-sm btn-xs btn-ghost"
                 aria-label="Prev">
                <span class="iconify lucide--chevron-left"></span>
              </a>
            {% endif %}
          
            {% for p in page_range %}
              <a href="?page={{ p }}&limit={{ limit }}"
                 class="btn btn-circle sm:btn-sm btn-xs {% if p == page %}btn-primary{% else %}btn-ghost{% endif %}">
                {{ p }}
              </a>
            {% endfor %}
          
            {% if page < max_page %}
              <a href="?page={{ page|add:"1" }}&limit={{ limit }}"
                 class="btn btn-circle sm:btn-sm btn-xs btn-ghost"
                 aria-label="Next">
                <span class="iconify lucide--chevron-right"></span>
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--코인 목록 끝-->
</div>
{% endblock dashboard_content %} 

{% block javascript %} 
{{ block.super }}
<script src="{% static 'js/pages/dashboard/ecommerce.js' %}"></script>
<script>
  window.showTab = function (tabName) {
    document.getElementById("summary-tab").classList.add("hidden");
    document.getElementById("chart-tab").classList.add("hidden");
  
    document.getElementById("summary-tab-button").classList.remove("tab-active");
    document.getElementById("chart-tab-button").classList.remove("tab-active");
  
    document.getElementById(`${tabName}-tab`).classList.remove("hidden");
    document.getElementById(`${tabName}-tab-button`).classList.add("tab-active");
  
    if (
      tabName === "chart" &&
      !document.getElementById("chart-tab").dataset.loaded
    ) {
      const options = {
        chart: { type: "pie", height: 300 },
        labels: JSON.parse('{{ pie_labels|default:"[]"|safe|escapejs }}'),
        series: JSON.parse('{{ pie_series|default:"[]"|safe|escapejs }}'),
        legend: { position: "bottom" },
      };
  
      const chart = new ApexCharts(
        document.querySelector("#portfolioPieChart"),
        options
      );
  
      chart.render();
      document.getElementById("chart-tab").dataset.loaded = "true";
    }
  };
  
</script>


{% endblock javascript %}
